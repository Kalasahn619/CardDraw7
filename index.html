<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardDraw11 – Random Luck</title>
    <meta name="description" content="A mystical lottery experience blending cryptographic randomness, numerology, and tarot symbolism">
    <link rel="manifest" href="manifest.json">
    <!-- Fallback for Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Fallback styling if Tailwind CSS fails to load -->
    <script>
    // Check if Tailwind CSS loaded, if not add fallback styles
    window.addEventListener('load', function() {
        const testElement = document.createElement('div');
        testElement.className = 'hidden';
        document.body.appendChild(testElement);
        const isHidden = window.getComputedStyle(testElement).display === 'none';
        document.body.removeChild(testElement);
        
        if (!isHidden) {
            // Tailwind CSS didn't load, add fallback
            const fallbackCSS = document.createElement('style');
            fallbackCSS.textContent = `
                .hidden { display: none !important; }
                .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
                .mx-auto { margin-left: auto; margin-right: auto; }
                .px-4 { padding-left: 1rem; padding-right: 1rem; }
                .py-8 { padding-top: 2rem; padding-bottom: 2rem; }
                .max-w-6xl { max-width: 72rem; }
                .text-center { text-align: center; }
                .mb-10 { margin-bottom: 2.5rem; }
                .text-4xl { font-size: 2.25rem; }
                .md\\:text-5xl { font-size: 3rem; }
                .font-bold { font-weight: 700; }
                .mb-2 { margin-bottom: 0.5rem; }
                .mb-6 { margin-bottom: 1.5rem; }
                .flex { display: flex; }
                .border-b { border-bottom: 1px solid; }
                .border-gray-700 { border-color: #374151; }
                .bg-gray-800 { background-color: #1f2937; }
                .bg-gray-700 { background-color: #374151; }
                .text-white { color: white; }
                .text-gray-300 { color: #d1d5db; }
                .text-gray-400 { color: #9ca3af; }
                .text-gray-500 { color: #6b7280; }
                .rounded-lg { border-radius: 0.5rem; }
                .p-4 { padding: 1rem; }
                .p-6 { padding: 1.5rem; }
                .grid { display: grid; }
                .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
                .lg\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
                .gap-6 { gap: 1.5rem; }
                .lg\\:col-span-1 { grid-column: span 1 / span 1; }
                .lg\\:col-span-2 { grid-column: span 2 / span 2; }
                .space-y-2 > * + * { margin-top: 0.5rem; }
                .space-y-4 > * + * { margin-top: 1rem; }
                .space-y-6 > * + * { margin-top: 1.5rem; }
                .space-x-2 > * + * { margin-left: 0.5rem; }
                .items-center { align-items: center; }
                .justify-between { justify-content: space-between; }
                .justify-center { justify-content: center; }
                .text-xl { font-size: 1.25rem; }
                .text-lg { font-size: 1.125rem; }
                .text-sm { font-size: 0.875rem; }
                .text-xs { font-size: 0.75rem; }
                .font-semibold { font-weight: 600; }
                .font-medium { font-weight: 500; }
                .mb-4 { margin-bottom: 1rem; }
                .mb-3 { margin-bottom: 0.75rem; }
                .mt-6 { margin-top: 1.5rem; }
                .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
                .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
                .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
                .bg-purple-600 { background-color: #9333ea; }
                .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
                .from-purple-600 { --tw-gradient-from: #9333ea; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(147, 51, 234, 0)); }
                .to-pink-600 { --tw-gradient-to: #db2777; }
                .hover\\:opacity-90:hover { opacity: 0.9; }
                .transition-opacity { transition-property: opacity; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
                .cursor-pointer { cursor: pointer; }
                body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #1f2937; color: white; margin: 0; padding: 0; }
                button { background: #374151; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; }
                button:hover { background: #4b5563; }
                input, select { background: #374151; color: white; border: 1px solid #4b5563; padding: 0.5rem; border-radius: 0.25rem; }
                .tab.active { background-color: rgba(255, 255, 255, 0.1); border-bottom: 2px solid #8b5cf6; }
            `;
            document.head.appendChild(fallbackCSS);
        }
    });
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dark-bg: #1f2937;
            --card-bg: #111827;
        }
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--dark-bg);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 20%);
            min-height: 100vh;
        }
        
        /* Card flip animation */
        .card-container {
            perspective: 1000px;
            width: 100px;
            height: 140px;
        }
        
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        
        .card.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 8px;
        }
        
        .card-front {
            background: var(--card-bg);
            background-image: var(--primary-gradient);
            color: white;
        }
        
        .card-back {
            background: white;
            color: var(--dark-bg);
            transform: rotateY(180deg);
            position: relative;
            overflow: hidden;
        }
        
        /* Card corners */
        .card-corner {
            position: absolute;
            font-size: 10px;
            font-weight: bold;
            line-height: 1;
            z-index: 10;
        }
        
        .card-corner.top-left {
            top: 4px;
            left: 4px;
        }
        
        .card-corner.bottom-right {
            bottom: 4px;
            right: 4px;
            transform: rotate(180deg);
        }
        
        /* Pips container */
        .pips-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 16px 8px;
        }
        
        .pip-row {
            display: flex;
            justify-content: center;
            width: 100%;
            position: relative;
        }
        
        .pip {
            font-size: 14px;
            margin: 0 2px;
            line-height: 1;
        }
        
        /* Sample card for simulation (smaller) */
        .sample-card-container {
            perspective: 1000px;
            width: 80px;
            height: 112px;
        }
        
        .sample-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        
        .sample-card.flipped {
            transform: rotateY(180deg);
        }
        
        .sample-card .card-face {
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sample-card .card-front {
            background: var(--card-bg);
            background-image: var(--primary-gradient);
            color: white;
        }
        
        .sample-card .card-corner {
            font-size: 8px;
        }
        
        .sample-card .pip {
            font-size: 11px;
        }
        
        .sample-card .pips-container {
            padding: 12px 6px;
        }
        
        /* Lotto numbers overlay */
        .lotto-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px;
            text-align: center;
            font-size: 9px;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }
        
        .lotto-number {
            font-weight: bold;
            color: #fbbf24;
        }
        
        .powerball-number {
            font-weight: bold;
            color: #f87171;
        }
        
        /* Small golden orb for simulation */
        .sample-orb {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff9800);
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #5d4037;
            animation: pulse 2s infinite;
        }
        
        /* Sparkle effect */
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: sparkle 1.5s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        /* Golden orb animation */
        .golden-orb {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ffeb3b, #ff9800);
            box-shadow: 0 0 30px rgba(255, 235, 59, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            color: #5d4037;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255, 235, 59, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px rgba(255, 235, 59, 0.9); }
        }
        
        /* Lucky numbers ball */
        .lucky-number-ball {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            margin: 0 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        
        .lucky-number-ball:hover {
            transform: scale(1.1);
        }
        
        /* Powerball results comparison */
        .powerball-result {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            color: #1f2937;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            margin: 0 2px;
        }
        
        .powerball-result.match {
            background: #10b981;
            color: white;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .powerball-result.powerball-match {
            background: #f59e0b;
            color: white;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        /* Drag and drop styles */
        .suit-item {
            cursor: move;
            transition: transform 0.2s;
        }
        
        .suit-item:hover {
            transform: translateY(-2px);
        }
        
        .suit-item.dragging {
            opacity: 0.5;
        }
        
        .suit-drop-zone {
            min-height: 60px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .suit-drop-zone.drag-over {
            border-color: rgba(102, 126, 234, 0.7);
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        /* Progress bar */
        .progress-bar {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s;
        }
        
        /* Tab styles */
        .tab {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid #8b5cf6;
        }
        
        .tab:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Digital root steps animation */
        .root-step {
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.5s forwards;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Verification message */
        .verification-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .verification-message.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Notification message */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(79, 70, 229, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 300px;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background: rgba(16, 185, 129, 0.9);
        }
        
        .notification.error {
            background: rgba(239, 68, 68, 0.9);
        }
        
        /* Responsive grid */
        @media (max-width: 640px) {
            .card-container {
                width: 70px;
                height: 100px;
            }
            
            .golden-orb {
                width: 80px;
                height: 80px;
                font-size: 1.5rem;
            }
            
            .pip {
                font-size: 10px;
            }
            
            .card-corner {
                font-size: 8px;
            }
            
            .sample-card-container {
                width: 60px;
                height: 84px;
            }
            
            .sample-orb {
                width: 60px;
                height: 60px;
                font-size: 1.2rem;
            }
            
            .lotto-overlay {
                font-size: 8px;
                padding: 2px;
            }
            
            .lucky-number-ball {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .powerball-result {
                width: 25px;
                height: 25px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
                CardDraw11 – Random Luck
            </h1>
            <p class="text-gray-300">A mystical lottery experience blending cryptographic randomness, numerology, and tarot symbolism</p>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Tabs Navigation -->
            <div class="flex border-b border-gray-700 mb-6">
                <div class="tab active" data-tab="draw">Card Draw</div>
                <div class="tab" data-tab="lucky">My Lucky Numbers</div>
                <div class="tab" data-tab="simulation">Simulation</div>
                <div class="tab" data-tab="history">History</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <!-- Tab Contents -->
            <div id="tab-content">
                <!-- Card Draw Tab -->
                <div id="draw-tab" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Suit Ordering -->
                        <div class="lg:col-span-1 bg-gray-800 rounded-lg p-4">
                            <h2 class="text-xl font-semibold mb-4">Suit Order</h2>
                            <p class="text-sm text-gray-400 mb-4">Drag suits to reorder based on your mystical alignment</p>
                            
                            <div class="mb-4">
                                <div class="flex space-x-2 mb-4">
                                    <button id="classic-order" class="px-3 py-1 bg-purple-600 rounded text-sm">Classic</button>
                                    <button id="reverse-order" class="px-3 py-1 bg-gray-700 rounded text-sm">Reverse</button>
                                    <button id="reset-order" class="px-3 py-1 bg-gray-700 rounded text-sm">Reset</button>
                                </div>
                                
                                <div id="suit-order-container" class="space-y-2">
                                    <!-- Suit items will be added here dynamically -->
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="text-lg font-medium mb-2">Tarot Meanings</h3>
                                <div class="text-sm space-y-1">
                                    <div>♥ = Cups (Emotions, Intuition)</div>
                                    <div>♦ = Pentacles (Material, Physical)</div>
                                    <div>♠ = Swords (Intellect, Conflict)</div>
                                    <div>♣ = Wands (Passion, Creativity)</div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <button id="verify-card-draw-btn" class="w-full px-3 py-2 bg-green-600 rounded text-sm hover:bg-green-700 transition-colors">
                                    Verify Card Draw Function
                                </button>
                            </div>
                        </div>
                        
                        <!-- Middle Column: Card Draw Area -->
                        <div class="lg:col-span-2 bg-gray-800 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-semibold">Card Draw</h2>
                                <button id="draw-cards-btn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-medium hover:opacity-90 transition-opacity">
                                    Draw 6 Cards
                                </button>
                            </div>
                            
                            <div id="cards-container" class="grid grid-cols-3 sm:grid-cols-6 gap-4 mb-6">
                                <!-- Cards will be added here dynamically -->
                            </div>
                            
                            <div id="digital-root-oracle" class="hidden">
                                <h3 class="text-lg font-medium mb-3 text-center">Digital Root Oracle</h3>
                                <div class="flex justify-center mb-4">
                                    <div class="golden-orb" id="golden-orb">0</div>
                                </div>
                                <div id="root-calculation-steps" class="text-center text-sm text-gray-300">
                                    <!-- Steps will be added here dynamically -->
                                </div>
                            </div>
                            
                            <div id="powerball-results" class="hidden mt-6">
                                <h3 class="text-lg font-medium mb-3">NZ Powerball Numbers</h3>
                                <div class="flex flex-wrap gap-2 justify-center mb-4">
                                    <div id="powerball-numbers" class="flex flex-wrap gap-2">
                                        <!-- Numbers will be added here dynamically -->
                                    </div>
                                    <div class="bg-yellow-500 text-gray-900 px-3 py-1 rounded font-bold" id="powerball-number">
                                        PB: 0
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button id="export-ticket-btn" class="px-3 py-1 bg-gray-700 rounded text-sm">Export Ticket</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Lucky Numbers Tab -->
                <div id="lucky-tab" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-6">My Lucky Numbers</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-medium mb-4">Daily Lucky Number</h3>
                                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                                    <div class="text-center mb-2">
                                        <span class="text-sm text-gray-400">Today's date:</span>
                                        <span id="today-date" class="ml-2"></span>
                                    </div>
                                    <div class="text-center mb-4">
                                        <span class="text-sm text-gray-400">Digital root:</span>
                                        <span id="daily-digital-root" class="ml-2 text-xl font-bold text-yellow-400">0</span>
                                    </div>
                                    <div class="text-center">
                                        <div class="lucky-number-ball text-xl" id="daily-lucky-number">0</div>
                                    <div class="text-xs mt-1 text-gray-400">Daily Lucky Number</div>
                                    </div>
                                </div>
                                
                                <h3 class="text-lg font-medium mb-4">My Frequent Numbers</h3>
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <div id="frequent-numbers" class="flex flex-wrap justify-center gap-2 mb-4">
                                        <!-- Frequent numbers will be added here dynamically -->
                                    </div>
                                    <div class="text-center text-sm text-gray-400" id="no-frequent-numbers">
                                        No draw history yet. Draw some cards to see your frequent numbers.
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-medium mb-4">Powerball Results Comparison</h3>
                                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <div>
                                            <label for="powerball-date" class="text-sm text-gray-400">Select date:</label>
                                            <input type="date" id="powerball-date" class="ml-2 bg-gray-600 text-white px-2 py-1 rounded text-sm">
                                        </div>
                                        <button id="fetch-powerball-btn" class="px-3 py-1 bg-purple-600 rounded text-sm hover:bg-purple-700 transition-colors">
                                            Fetch Results
                                        </button>
                                    </div>
                                    
                                    <div id="powerball-comparison" class="hidden">
                                        <div class="mb-4">
                                            <div class="text-sm text-gray-400 mb-2">Winning Numbers:</div>
                                            <div id="winning-numbers" class="flex flex-wrap justify-center gap-1">
                                                <!-- Winning numbers will be added here dynamically -->
                                            </div>
                                        </div>
                                        
                                        <div class="mb-4">
                                            <div class="text-sm text-gray-400 mb-2">Your Lucky Numbers:</div>
                                            <div id="lucky-numbers-comparison" class="flex flex-wrap justify-center gap-1">
                                                <!-- Lucky numbers will be added here dynamically -->
                                            </div>
                                        </div>
                                        
                                        <div id="matches-info" class="text-center text-sm">
                                            <!-- Matches info will be added here dynamically -->
                                        </div>
                                    </div>
                                    
                                    <div id="no-powerball-data" class="text-center text-gray-500">
                                        Select a date and fetch Powerball results to see comparison.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Simulation Tab -->
                <div id="simulation-tab" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-4">Monte Carlo Simulation</h2>
                        <p class="text-gray-400 mb-6">Run simulated draws to analyze patterns and frequencies</p>
                        
                        <div class="mb-6">
                            <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                                <button id="run-simulation-btn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-medium hover:opacity-90 transition-opacity">
                                    Run Simulation
                                </button>
                                
                                <div class="flex items-center gap-2">
                                    <label for="simulation-draws" class="text-sm">Number of draws:</label>
                                    <select id="simulation-draws" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                        <option value="300">300</option>
                                        <option value="400">400</option>
                                        <option value="500" selected>500</option>
                                        <option value="600">600</option>
                                        <option value="700">700</option>
                                        <option value="800">800</option>
                                        <option value="900">900</option>
                                        <option value="1000">1000</option>
                                        <option value="1100">1100</option>
                                        <option value="1200">1200</option>
                                        <option value="1300">1300</option>
                                        <option value="1400">1400</option>
                                        <option value="1500">1500</option>
                                        <option value="1600">1600</option>
                                        <option value="1700">1700</option>
                                        <option value="1800">1800</option>
                                        <option value="1900">1900</option>
                                        <option value="2000">2000</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="simulation-progress" class="hidden mt-4">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Progress</span>
                                    <span id="progress-text">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progress-fill"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="simulation-results" class="hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-lg font-medium mb-3">Card Frequency</h3>
                                    <div id="card-frequency-chart" class="h-64">
                                        <!-- Chart will be added here dynamically -->
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-lg font-medium mb-3">Digital Root Distribution</h3>
                                    <div id="root-distribution-chart" class="h-64">
                                        <!-- Chart will be added here dynamically -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="text-lg font-medium mb-3">Top 6 Cards by Frequency</h3>
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <div id="top-cards-container" class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-4">
                                        <!-- Top cards will be added here dynamically -->
                                    </div>
                                    <div id="top-cards-powerball" class="text-center">
                                        <div class="inline-block bg-yellow-500 text-gray-900 px-3 py-1 rounded font-bold text-sm">
                                            PB: <span id="top-cards-pb-number">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="text-lg font-medium mb-3">Sample Draw</h3>
                                <div class="bg-gray-700 rounded-lg p-4">
                                    <div id="sample-cards-container" class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-4">
                                        <!-- Sample cards will be added here dynamically -->
                                    </div>
                                    
                                    <div class="flex flex-col items-center">
                                        <div class="sample-orb mb-3" id="sample-orb">0</div>
                                        <div id="sample-powerball-numbers" class="flex flex-wrap gap-2 justify-center mb-3">
                                            <!-- Powerball numbers will be added here dynamically -->
                                        </div>
                                        <div class="bg-yellow-500 text-gray-900 px-3 py-1 rounded font-bold" id="sample-powerball-number">
                                            PB: 0
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <h3 class="text-lg font-medium mb-3">Simulation Summary</h3>
                                <div id="simulation-summary" class="bg-gray-700 rounded p-4">
                                    <!-- Summary will be added here dynamically -->
                                </div>
                            </div>
                            
                            <div class="text-center mt-6">
                                <button id="export-simulation-btn" class="px-3 py-1 bg-gray-700 rounded text-sm">Export Results</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div id="history-tab" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Draw History</h2>
                            <div class="flex space-x-2">
                                <button id="export-history-btn" class="px-3 py-1 bg-gray-700 rounded text-sm">Export JSON</button>
                                <button id="export-csv-btn" class="px-3 py-1 bg-gray-700 rounded text-sm">Export CSV</button>
                                <button id="clear-history-btn" class="px-3 py-1 bg-red-600 rounded text-sm">Clear History</button>
                            </div>
                        </div>
                        
                        <div id="history-container" class="space-y-4">
                            <!-- History items will be added here dynamically -->
                        </div>
                        
                        <div id="empty-history" class="text-center py-10 text-gray-500">
                            No draw history yet. Draw some cards to see them here.
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div id="settings-tab" class="tab-content hidden">
                    <div class="bg-gray-800 rounded-lg p-6">
                        <h2 class="text-xl font-semibold mb-6">Settings</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-medium mb-3">App Preferences</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="save-history" class="mr-2" checked>
                                        <label for="save-history">Save draw history locally</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="enable-animations" class="mr-2" checked>
                                        <label for="enable-animations">Enable card animations</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="show-tarot-meanings" class="mr-2" checked>
                                        <label for="show-tarot-meanings">Show tarot meanings on cards</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-medium mb-3">Data Management</h3>
                                <div class="space-y-3">
                                    <button id="import-data-btn" class="px-3 py-1 bg-gray-700 rounded text-sm">Import Data</button>
                                    <input type="file" id="import-file" class="hidden" accept=".json">
                                    <p class="text-sm text-gray-400">Import previously exported data</p>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-medium mb-3">About</h3>
                                <p class="text-gray-400">CardDraw11 – Random Luck v1.0</p>
                                <p class="text-gray-400">A mystical lottery experience blending cryptographic randomness, numerology, and tarot symbolism</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Verification Message -->
    <div id="verification-message" class="verification-message">
        Card draw function verified successfully!
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
    </div>

    <script>
        // Application State
        const appState = {
            suits: [
                { symbol: '♥', name: 'hearts', tarot: 'Cups', position: 0, color: '#e53e3e' },
                { symbol: '♦', name: 'diamonds', tarot: 'Pentacles', position: 1, color: '#dd6b20' },
                { symbol: '♠', name: 'spades', tarot: 'Swords', position: 2, color: '#2d3748' },
                { symbol: '♣', name: 'clubs', tarot: 'Wands', position: 3, color: '#38a169' }
            ],
            currentCards: [],
            history: [],
            simulationResults: null,
            settings: {
                saveHistory: true,
                enableAnimations: true,
                showTarotMeanings: true
            },
            powerballResults: {} // Store fetched Powerball results
        };

        // DOM Elements
        const elements = {
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            suitOrderContainer: document.getElementById('suit-order-container'),
            cardsContainer: document.getElementById('cards-container'),
            drawCardsBtn: document.getElementById('draw-cards-btn'),
            verifyCardDrawBtn: document.getElementById('verify-card-draw-btn'),
            verificationMessage: document.getElementById('verification-message'),
            notification: document.getElementById('notification'),
            notificationText: document.getElementById('notification-text'),
            digitalRootOracle: document.getElementById('digital-root-oracle'),
            goldenOrb: document.getElementById('golden-orb'),
            rootCalculationSteps: document.getElementById('root-calculation-steps'),
            powerballResults: document.getElementById('powerball-results'),
            powerballNumbers: document.getElementById('powerball-numbers'),
            powerballNumber: document.getElementById('powerball-number'),
            exportTicketBtn: document.getElementById('export-ticket-btn'),
            runSimulationBtn: document.getElementById('run-simulation-btn'),
            simulationDraws: document.getElementById('simulation-draws'),
            simulationProgress: document.getElementById('simulation-progress'),
            progressFill: document.getElementById('progress-fill'),
            progressText: document.getElementById('progress-text'),
            simulationResults: document.getElementById('simulation-results'),
            cardFrequencyChart: document.getElementById('card-frequency-chart'),
            rootDistributionChart: document.getElementById('root-distribution-chart'),
            simulationSummary: document.getElementById('simulation-summary'),
            topCardsContainer: document.getElementById('top-cards-container'),
            topCardsPbNumber: document.getElementById('top-cards-pb-number'),
            sampleCardsContainer: document.getElementById('sample-cards-container'),
            sampleOrb: document.getElementById('sample-orb'),
            samplePowerballNumbers: document.getElementById('sample-powerball-numbers'),
            samplePowerballNumber: document.getElementById('sample-powerball-number'),
            exportSimulationBtn: document.getElementById('export-simulation-btn'),
            historyContainer: document.getElementById('history-container'),
            emptyHistory: document.getElementById('empty-history'),
            exportHistoryBtn: document.getElementById('export-history-btn'),
            exportCsvBtn: document.getElementById('export-csv-btn'),
            clearHistoryBtn: document.getElementById('clear-history-btn'),
            classicOrderBtn: document.getElementById('classic-order'),
            reverseOrderBtn: document.getElementById('reverse-order'),
            resetOrderBtn: document.getElementById('reset-order'),
            saveHistoryCheckbox: document.getElementById('save-history'),
            enableAnimationsCheckbox: document.getElementById('enable-animations'),
            showTarotMeaningsCheckbox: document.getElementById('show-tarot-meanings'),
            importDataBtn: document.getElementById('import-data-btn'),
            importFile: document.getElementById('import-file'),
            // Lucky Numbers elements
            todayDate: document.getElementById('today-date'),
            dailyDigitalRoot: document.getElementById('daily-digital-root'),
            dailyLuckyNumber: document.getElementById('daily-lucky-number'),
            frequentNumbers: document.getElementById('frequent-numbers'),
            noFrequentNumbers: document.getElementById('no-frequent-numbers'),
            powerballDate: document.getElementById('powerball-date'),
            fetchPowerballBtn: document.getElementById('fetch-powerball-btn'),
            powerballComparison: document.getElementById('powerball-comparison'),
            winningNumbers: document.getElementById('winning-numbers'),
            luckyNumbersComparison: document.getElementById('lucky-numbers-comparison'),
            matchesInfo: document.getElementById('matches-info'),
            noPowerballData: document.getElementById('no-powerball-data')
        };

        // Initialize the application
        function init() {
            loadSettings();
            loadHistory();
            loadPowerballResults();
            setupEventListeners();
            renderSuitOrder();
            renderHistory();
            updateDailyLuckyNumber();
            updateFrequentNumbers();
            setupPWA();
            
            // Set today's date as default
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            elements.powerballDate.value = formattedDate;
            elements.powerballDate.max = formattedDate;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Card draw
            elements.drawCardsBtn.addEventListener('click', drawCards);
            elements.verifyCardDrawBtn.addEventListener('click', verifyCardDrawFunction);
            elements.exportTicketBtn.addEventListener('click', exportTicket);

            // Simulation
            elements.runSimulationBtn.addEventListener('click', runSimulation);
            elements.exportSimulationBtn.addEventListener('click', exportSimulation);

            // History
            elements.exportHistoryBtn.addEventListener('click', () => exportHistory('json'));
            elements.exportCsvBtn.addEventListener('click', () => exportHistory('csv'));
            elements.clearHistoryBtn.addEventListener('click', clearHistory);

            // Suit ordering
            elements.classicOrderBtn.addEventListener('click', setClassicOrder);
            elements.reverseOrderBtn.addEventListener('click', setReverseOrder);
            elements.resetOrderBtn.addEventListener('click', resetSuitOrder);

            // Settings
            elements.saveHistoryCheckbox.addEventListener('change', updateSetting);
            elements.enableAnimationsCheckbox.addEventListener('change', updateSetting);
            elements.showTarotMeaningsCheckbox.addEventListener('change', updateSetting);
            elements.importDataBtn.addEventListener('click', () => elements.importFile.click());
            elements.importFile.addEventListener('change', importData);
            
            // Lucky Numbers
            elements.fetchPowerballBtn.addEventListener('click', fetchPowerballResults);
        }

        // Tab switching
        function switchTab(tabName) {
            elements.tabs.forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            elements.tabContents.forEach(content => {
                if (content.id === `${tabName}-tab`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Update lucky numbers when switching to the tab
            if (tabName === 'lucky') {
                updateDailyLuckyNumber();
                updateFrequentNumbers();
            }
        }

        // Render suit order UI
        function renderSuitOrder() {
            elements.suitOrderContainer.innerHTML = '';
            
            appState.suits.forEach((suit, index) => {
                const suitItem = document.createElement('div');
                suitItem.className = 'suit-item bg-gray-700 p-3 rounded-lg flex items-center justify-between';
                suitItem.draggable = true;
                suitItem.dataset.suitIndex = index;
                
                suitItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-2" style="color: ${suit.color}">${suit.symbol}</span>
                        <span>${suit.tarot}</span>
                    </div>
                    <span class="text-gray-400">Position: ${suit.position}</span>
                `;
                
                // Drag and drop events
                suitItem.addEventListener('dragstart', handleDragStart);
                suitItem.addEventListener('dragover', handleDragOver);
                suitItem.addEventListener('drop', handleDrop);
                suitItem.addEventListener('dragend', handleDragEnd);
                
                elements.suitOrderContainer.appendChild(suitItem);
            });
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.suitIndex);
                const targetIndex = parseInt(this.dataset.suitIndex);
                
                // Reorder suits array
                const draggedSuit = appState.suits[draggedIndex];
                appState.suits.splice(draggedIndex, 1);
                appState.suits.splice(targetIndex, 0, draggedSuit);
                
                // Update positions
                appState.suits.forEach((suit, index) => {
                    suit.position = index;
                });
                
                renderSuitOrder();
                saveSettings();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            const suitItems = document.querySelectorAll('.suit-item');
            suitItems.forEach(item => {
                item.classList.remove('dragging', 'drag-over');
            });
        }

        // Suit order presets
        function setClassicOrder() {
            appState.suits = [
                { symbol: '♥', name: 'hearts', tarot: 'Cups', position: 0, color: '#e53e3e' },
                { symbol: '♦', name: 'diamonds', tarot: 'Pentacles', position: 1, color: '#dd6b20' },
                { symbol: '♠', name: 'spades', tarot: 'Swords', position: 2, color: '#2d3748' },
                { symbol: '♣', name: 'clubs', tarot: 'Wands', position: 3, color: '#38a169' }
            ];
            renderSuitOrder();
            saveSettings();
        }

        function setReverseOrder() {
            appState.suits = [
                { symbol: '♣', name: 'clubs', tarot: 'Wands', position: 0, color: '#38a169' },
                { symbol: '♠', name: 'spades', tarot: 'Swords', position: 1, color: '#2d3748' },
                { symbol: '♦', name: 'diamonds', tarot: 'Pentacles', position: 2, color: '#dd6b20' },
                { symbol: '♥', name: 'hearts', tarot: 'Cups', position: 3, color: '#e53e3e' }
            ];
            renderSuitOrder();
            saveSettings();
        }

        function resetSuitOrder() {
            // Load the saved order or use classic as default
            const savedOrder = localStorage.getItem('cardDraw11_suitOrder');
            if (savedOrder) {
                appState.suits = JSON.parse(savedOrder);
            } else {
                setClassicOrder();
            }
        }

        // Generate pips layout for cards
        function generatePipsLayout(value) {
            const layouts = {
                1: [[1, 1]], // Center
                2: [[0, 1], [2, 1]], // Top and bottom
                3: [[0, 1], [1, 1], [2, 1]], // Top, center, bottom
                4: [[0, 0], [0, 2], [2, 0], [2, 2]], // Four corners
                5: [[0, 0], [0, 2], [1, 1], [2, 0], [2, 2]], // Four corners and center
                6: [[0, 0], [0, 2], [1, 0], [1, 2], [2, 0], [2, 2]], // Two columns of three
                7: [[0, 0], [0, 2], [1, 0], [1, 1], [1, 2], [2, 0], [2, 2]], // Six plus center
                8: [[0, 0], [0, 2], [1, 0], [1, 2], [2, 0], [2, 2], [3, 0], [3, 2]], // Two columns of four
                9: [[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2], [2, 0], [2, 1], [2, 2]], // Three columns of three
                10: [[0, 0], [0, 2], [1, 0], [1, 2], [2, 0], [2, 2], [3, 0], [3, 2], [4, 0], [4, 2]] // Two columns of five
            };
            
            return layouts[value] || [];
        }

        // Generate pips HTML for a card
        function generatePipsHTML(value, suitSymbol, suitColor, isSmall = false) {
            const layout = generatePipsLayout(value);
            const maxRow = Math.max(...layout.map(pos => pos[0]));
            const rows = maxRow + 1;
            
            let html = `<div class="pips-container" style="${isSmall ? 'padding: 12px 6px;' : 'padding: 16px 8px;'}">`;
            
            for (let row = 0; row < rows; row++) {
                html += '<div class="pip-row">';
                
                const rowPips = layout.filter(pos => pos[0] === row);
                const maxCol = Math.max(...rowPips.map(pos => pos[1]), 0);
                const cols = maxCol + 1;
                
                for (let col = 0; col < cols; col++) {
                    if (layout.some(pos => pos[0] === row && pos[1] === col)) {
                        html += `<span class="pip" style="color: ${suitColor}; ${isSmall ? 'font-size: 11px;' : ''}">${suitSymbol}</span>`;
                    } else {
                        html += `<span class="pip" style="visibility: hidden; ${isSmall ? 'font-size: 11px;' : ''}">♠</span>`; // Invisible spacer
                    }
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        // Create sample card element for simulation results
        function createSampleCardElement(card, lottoNumber = null, powerballNumber = null, showNumbers = false) {
            const cardContainer = document.createElement('div');
            cardContainer.className = 'sample-card-container';
            
            const cardElement = document.createElement('div');
            cardElement.className = 'sample-card';
            
            // Card front
            const cardFront = document.createElement('div');
            cardFront.className = 'card-face card-front';
            
            // Add sparkle effects
            for (let i = 0; i < 3; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = `${Math.random() * 100}%`;
                sparkle.style.top = `${Math.random() * 100}%`;
                sparkle.style.animationDelay = `${Math.random() * 2}s`;
                cardFront.appendChild(sparkle);
            }
            
            // Card back
            const cardBack = document.createElement('div');
            cardBack.className = 'card-face card-back';
            
            // Generate card content with pips
            const pipsHTML = generatePipsHTML(card.value, card.suit.symbol, card.suit.color, true);
            
            cardBack.innerHTML = `
                <div class="card-corner top-left">
                    <div class="value">${card.value}</div>
                    <div class="suit" style="color: ${card.suit.color}">${card.suit.symbol}</div>
                </div>
                ${pipsHTML}
                <div class="card-corner bottom-right">
                    <div class="value">${card.value}</div>
                    <div class="suit" style="color: ${card.suit.color}">${card.suit.symbol}</div>
                </div>
                ${appState.settings.showTarotMeanings ? `<div class="absolute bottom-1 left-0 right-0 text-center text-xs text-gray-500">${card.suit.tarot}</div>` : ''}
                ${showNumbers && lottoNumber !== null ? `
                    <div class="lotto-overlay">
                        <div>Lotto: <span class="lotto-number">${lottoNumber}</span></div>
                        ${powerballNumber !== null ? `<div>PB: <span class="powerball-number">${powerballNumber}</span></div>` : ''}
                    </div>
                ` : ''}
            `;
            
            cardElement.appendChild(cardFront);
            cardElement.appendChild(cardBack);
            cardContainer.appendChild(cardElement);
            
            return cardContainer;
        }

        // Verify card draw function
        function verifyCardDrawFunction() {
            console.log("Verifying card draw function...");
            
            // Test 1: Generate a deck of 40 cards
            const deck = [];
            appState.suits.forEach(suit => {
                for (let value = 1; value <= 10; value++) {
                    deck.push({
                        suit: suit,
                        value: value,
                        codex: (suit.position * 10) + value
                    });
                }
            });
            
            if (deck.length !== 40) {
                console.error("Test 1 failed: Deck does not contain 40 cards");
                return false;
            }
            console.log("Test 1 passed: Deck contains 40 cards");
            
            // Test 2: Draw 6 unique cards
            const testDeck = [...deck];
            const drawnCards = [];
            const indices = new Uint16Array(6);
            crypto.getRandomValues(indices);
            
            for (let i = 0; i < 6; i++) {
                const index = indices[i] % testDeck.length;
                drawnCards.push(testDeck[index]);
                testDeck.splice(index, 1);
            }
            
            if (drawnCards.length !== 6) {
                console.error("Test 2 failed: Did not draw 6 cards");
                return false;
            }
            
            // Check for duplicates
            const cardSet = new Set(drawnCards.map(card => `${card.suit.name}-${card.value}`));
            if (cardSet.size !== 6) {
                console.error("Test 2 failed: Duplicate cards drawn");
                return false;
            }
            console.log("Test 2 passed: Drew 6 unique cards");
            
            // Test 3: Verify codex calculation
            for (const card of drawnCards) {
                const expectedCodex = (card.suit.position * 10) + card.value;
                if (card.codex !== expectedCodex) {
                    console.error(`Test 3 failed: Incorrect codex for ${card.suit.name} ${card.value}. Expected ${expectedCodex}, got ${card.codex}`);
                    return false;
                }
            }
            console.log("Test 3 passed: Codex values calculated correctly");
            
            // Test 4: Verify digital root calculation
            const codexSum = drawnCards.reduce((sum, card) => sum + card.codex, 0);
            const root = calculateDigitalRootValue(codexSum);
            const expectedRoot = 1 + ((codexSum - 1) % 9);
            
            if (root !== expectedRoot) {
                console.error(`Test 4 failed: Incorrect digital root. Expected ${expectedRoot}, got ${root}`);
                return false;
            }
            console.log("Test 4 passed: Digital root calculated correctly");
            
            // Test 5: Verify Powerball number generation
            const powerballNumbers = drawnCards.map(card => {
                return ((card.codex - 1) % 40) + 1;
            });
            
            for (const num of powerballNumbers) {
                if (num < 1 || num > 40) {
                    console.error(`Test 5 failed: Powerball number out of range (1-40): ${num}`);
                    return false;
                }
            }
            console.log("Test 5 passed: Powerball numbers within valid range");
            
            // Show verification message
            elements.verificationMessage.classList.add('show');
            setTimeout(() => {
                elements.verificationMessage.classList.remove('show');
            }, 3000);
            
            return true;
        }

        // Update daily lucky number
        function updateDailyLuckyNumber() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            elements.todayDate.textContent = dateString;
            
            // Calculate digital root from today's date
            const day = today.getDate();
            const month = today.getMonth() + 1; // Months are 0-indexed
            const year = today.getFullYear();
            
            // Sum all digits of the date
            const dateSum = day.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0) +
                           month.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0) +
                           year.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0);
            
            // Calculate digital root
            const digitalRoot = calculateDigitalRootValue(dateSum);
            elements.dailyDigitalRoot.textContent = digitalRoot;
            elements.dailyLuckyNumber.textContent = digitalRoot;
        }

        // Update frequent numbers
        function updateFrequentNumbers() {
            // Get all Powerball numbers from history
            const allNumbers = [];
            const powerballNumbers = [];
            
            appState.history.forEach(entry => {
                if (entry.cards && entry.type === 'manual') {
                    entry.cards.forEach(card => {
                        const lottoNumber = ((card.codex - 1) % 40) + 1;
                        allNumbers.push(lottoNumber);
                    });
                    
                    if (entry.digitalRoot) {
                        powerballNumbers.push(entry.digitalRoot);
                    }
                }
            });
            
            // Count frequency of each number
            const numberFrequency = {};
            const powerballFrequency = {};
            
            allNumbers.forEach(num => {
                numberFrequency[num] = (numberFrequency[num] || 0) + 1;
            });
            
            powerballNumbers.forEach(num => {
                powerballFrequency[num] = (powerballFrequency[num] || 0) + 1;
            });
            
            // Sort by frequency and get top numbers
            const sortedNumbers = Object.entries(numberFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 numbers
                
            const sortedPowerball = Object.entries(powerballFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3); // Top 3 Powerball numbers
            
            // Display frequent numbers
            elements.frequentNumbers.innerHTML = '';
            
            if (sortedNumbers.length === 0) {
                elements.noFrequentNumbers.classList.remove('hidden');
            } else {
                elements.noFrequentNumbers.classList.add('hidden');
                
                sortedNumbers.forEach(([num, frequency]) => {
                    const numberBall = document.createElement('div');
                    numberBall.className = 'lucky-number-ball';
                    numberBall.textContent = num;
                    numberBall.title = `Appeared ${frequency} times`;
                    elements.frequentNumbers.appendChild(numberBall);
                });
            }
        }

        // Fetch Powerball results
        async function fetchPowerballResults() {
            const selectedDate = elements.powerballDate.value;
            
            // Check if we already have results for this date
            if (appState.powerballResults[selectedDate]) {
                displayPowerballComparison(selectedDate);
                return;
            }
            
            // Show loading state
            elements.fetchPowerballBtn.disabled = true;
            elements.fetchPowerballBtn.textContent = 'Fetching...';
            
            try {
                // In a real implementation, you would fetch from an actual API
                // For this demo, we'll generate mock results
                const mockResults = generateMockPowerballResults(selectedDate);
                
                // Save results
                appState.powerballResults[selectedDate] = mockResults;
                
                // Save to localStorage
                localStorage.setItem('cardDraw11_powerballResults', JSON.stringify(appState.powerballResults));
                
                // Display comparison
                displayPowerballComparison(selectedDate);
                
                showNotification('Powerball results fetched successfully!', 'success');
            } catch (error) {
                console.error('Error fetching Powerball results:', error);
                showNotification('Failed to fetch Powerball results. Please try again.', 'error');
            } finally {
                // Reset button state
                elements.fetchPowerballBtn.disabled = false;
                elements.fetchPowerballBtn.textContent = 'Fetch Results';
            }
        }

        // Generate mock Powerball results for demo purposes
        function generateMockPowerballResults(date) {
            // In a real implementation, this would be replaced with an actual API call
            const numbers = [];
            const indices = new Uint8Array(6);
            crypto.getRandomValues(indices);
            
            for (let i = 0; i < 6; i++) {
                numbers.push((indices[i] % 40) + 1);
            }
            
            numbers.sort((a, b) => a - b);
            
            const powerball = (indices[5] % 10) + 1;
            
            return {
                date: date,
                numbers: numbers,
                powerball: powerball
            };
        }

        // Display Powerball comparison
        function displayPowerballComparison(date) {
            const results = appState.powerballResults[date];
            
            if (!results) {
                elements.noPowerballData.classList.remove('hidden');
                elements.powerballComparison.classList.add('hidden');
                return;
            }
            
            elements.noPowerballData.classList.add('hidden');
            elements.powerballComparison.classList.remove('hidden');
            
            // Display winning numbers
            elements.winningNumbers.innerHTML = '';
            results.numbers.forEach(num => {
                const numberBall = document.createElement('div');
                numberBall.className = 'powerball-result';
                numberBall.textContent = num;
                elements.winningNumbers.appendChild(numberBall);
            });
            
            // Display Powerball number
            const powerballBall = document.createElement('div');
            powerballBall.className = 'powerball-result powerball-match';
            powerballBall.textContent = results.powerball;
            elements.winningNumbers.appendChild(powerballBall);
            
            // Get user's lucky numbers
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            const dateSum = today.getDate() + (today.getMonth() + 1) + today.getFullYear();
            const digitalRoot = calculateDigitalRootValue(dateSum);
            
            // Get frequent numbers from history
            const allNumbers = [];
            appState.history.forEach(entry => {
                if (entry.cards && entry.type === 'manual') {
                    entry.cards.forEach(card => {
                        const lottoNumber = ((card.codex - 1) % 40) + 1;
                        allNumbers.push(lottoNumber);
                    });
                }
            });
            
            // Count frequency and get top numbers
            const numberFrequency = {};
            allNumbers.forEach(num => {
                numberFrequency[num] = (numberFrequency[num] || 0) + 1;
            });
            
            const sortedNumbers = Object.entries(numberFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6)
                .map(([num]) => parseInt(num));
            
            // Add daily lucky number
            const userNumbers = [...sortedNumbers, digitalRoot];
            
            // Display user's lucky numbers
            elements.luckyNumbersComparison.innerHTML = '';
            userNumbers.forEach(num => {
                const numberBall = document.createElement('div');
                numberBall.className = 'powerball-result';
                
                // Check if this number matches any winning number
                if (results.numbers.includes(num)) {
                    numberBall.classList.add('match');
                }
                
                // Check if this is the Powerball number
                if (num === results.powerball) {
                    numberBall.classList.add('powerball-match');
                }
                
                numberBall.textContent = num;
                elements.luckyNumbersComparison.appendChild(numberBall);
            });
            
            // Count matches
            const numberMatches = userNumbers.filter(num => results.numbers.includes(num)).length;
            const powerballMatch = userNumbers.includes(results.powerball) ? 1 : 0;
            
            // Display match information
            elements.matchesInfo.innerHTML = `
                <div class="mb-2">
                    <span class="text-green-400 font-bold">${numberMatches}</span> main number${numberMatches !== 1 ? 's' : ''} matched
                </div>
                ${powerballMatch ? '<div class="text-yellow-400 font-bold">Powerball number matched!</div>' : ''}
                <div class="text-sm text-gray-400 mt-2">
                    Your lucky numbers: ${userNumbers.join(', ')}
                </div>
            `;
        }

        // Load Powerball results from localStorage
        function loadPowerballResults() {
            const savedResults = localStorage.getItem('cardDraw11_powerballResults');
            if (savedResults) {
                appState.powerballResults = JSON.parse(savedResults);
            }
        }

        // Show notification
        function showNotification(message, type = 'info') {
            elements.notificationText.textContent = message;
            elements.notification.className = `notification ${type}`;
            elements.notification.classList.add('show');
            
            setTimeout(() => {
                elements.notification.classList.remove('show');
            }, 3000);
        }

        // Card drawing
        function drawCards() {
            // Reset UI
            elements.cardsContainer.innerHTML = '';
            elements.digitalRootOracle.classList.add('hidden');
            elements.powerballResults.classList.add('hidden');
            
            // Generate a deck of 40 cards
            const deck = [];
            appState.suits.forEach(suit => {
                for (let value = 1; value <= 10; value++) {
                    deck.push({
                        suit: suit,
                        value: value,
                        codex: (suit.position * 10) + value
                    });
                }
            });
            
            // Draw 6 unique cards using crypto.getRandomValues
            const drawnCards = [];
            const indices = new Uint16Array(6);
            crypto.getRandomValues(indices);
            
            for (let i = 0; i < 6; i++) {
                const index = indices[i] % deck.length;
                drawnCards.push(deck[index]);
                deck.splice(index, 1);
            }
            
            appState.currentCards = drawnCards;
            
            // Render cards
            renderCards(drawnCards);
            
            // Calculate digital root
            setTimeout(() => {
                calculateDigitalRoot(drawnCards);
            }, appState.settings.enableAnimations ? 2000 : 0);
            
            // Save to history
            if (appState.settings.saveHistory) {
                saveToHistory(drawnCards);
            }
            
            // Update frequent numbers
            updateFrequentNumbers();
        }

        // Render cards with flip animation
        function renderCards(cards) {
            elements.cardsContainer.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'card-container';
                
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                
                // Card front
                const cardFront = document.createElement('div');
                cardFront.className = 'card-face card-front';
                
                // Add sparkle effects
                for (let i = 0; i < 5; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = `${Math.random() * 100}%`;
                    sparkle.style.top = `${Math.random() * 100}%`;
                    sparkle.style.animationDelay = `${Math.random() * 2}s`;
                    cardFront.appendChild(sparkle);
                }
                
                // Card back
                const cardBack = document.createElement('div');
                cardBack.className = 'card-face card-back';
                
                // Generate card content with pips
                const pipsHTML = generatePipsHTML(card.value, card.suit.symbol, card.suit.color);
                
                cardBack.innerHTML = `
                    <div class="card-corner top-left">
                        <div class="value">${card.value}</div>
                        <div class="suit" style="color: ${card.suit.color}">${card.suit.symbol}</div>
                    </div>
                    ${pipsHTML}
                    <div class="card-corner bottom-right">
                        <div class="value">${card.value}</div>
                        <div class="suit" style="color: ${card.suit.color}">${card.suit.symbol}</div>
                    </div>
                    ${appState.settings.showTarotMeanings ? `<div class="absolute bottom-1 left-0 right-0 text-center text-xs text-gray-500">${card.suit.tarot}</div>` : ''}
                `;
                
                cardElement.appendChild(cardFront);
                cardElement.appendChild(cardBack);
                cardContainer.appendChild(cardElement);
                elements.cardsContainer.appendChild(cardContainer);
                
                // Flip card with delay
                setTimeout(() => {
                    cardElement.classList.add('flipped');
                }, index * (appState.settings.enableAnimations ? 300 : 0));
            });
        }

        // Calculate digital root
        function calculateDigitalRoot(cards) {
            const codexSum = cards.reduce((sum, card) => sum + card.codex, 0);
            const root = calculateDigitalRootValue(codexSum);
            
            // Show oracle
            elements.digitalRootOracle.classList.remove('hidden');
            
            // Animate golden orb
            animateGoldenOrb(root);
            
            // Show calculation steps
            showCalculationSteps(codexSum, root);
            
            // Generate Powerball numbers
            generatePowerballNumbers(cards, root);
        }

        function calculateDigitalRootValue(n) {
            if (n === 0) return 0;
            return 1 + ((n - 1) % 9);
        }

        function animateGoldenOrb(root) {
            elements.goldenOrb.textContent = root;
            elements.goldenOrb.style.animation = 'none';
            setTimeout(() => {
                elements.goldenOrb.style.animation = 'pulse 2s infinite';
            }, 10);
        }

        function showCalculationSteps(codexSum, root) {
            elements.rootCalculationSteps.innerHTML = '';
            
            const steps = [
                `Sum of codex values: ${codexSum}`,
                `Digital root calculation: ${codexSum} → ${root}`
            ];
            
            steps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'root-step';
                stepElement.textContent = step;
                stepElement.style.animationDelay = `${index * 0.5}s`;
                elements.rootCalculationSteps.appendChild(stepElement);
            });
        }

        // Generate Powerball numbers
        function generatePowerballNumbers(cards, root) {
            elements.powerballResults.classList.remove('hidden');
            elements.powerballNumbers.innerHTML = '';
            
            // Generate 6 numbers from 1-40 based on codex values
            const numbers = cards.map(card => {
                // Map codex value (1-43) to Powerball range (1-40)
                return ((card.codex - 1) % 40) + 1;
            });
            
            // Sort numbers
            numbers.sort((a, b) => a - b);
            
            // Display numbers
            numbers.forEach(num => {
                const numberElement = document.createElement('div');
                numberElement.className = 'bg-white text-gray-900 w-10 h-10 rounded-full flex items-center justify-center font-bold';
                numberElement.textContent = num;
                elements.powerballNumbers.appendChild(numberElement);
            });
            
            // Set Powerball number (digital root)
            elements.powerballNumber.textContent = `PB: ${root}`;
        }

        // Export ticket
        function exportTicket() {
            const ticket = {
                timestamp: new Date().toISOString(),
                cards: appState.currentCards.map(card => ({
                    suit: card.suit.name,
                    value: card.value,
                    codex: card.codex
                })),
                powerballNumbers: Array.from(elements.powerballNumbers.children).map(el => parseInt(el.textContent)),
                powerball: parseInt(elements.powerballNumber.textContent.replace('PB: ', '')),
                digitalRoot: parseInt(elements.goldenOrb.textContent)
            };
            
            const dataStr = JSON.stringify(ticket, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `carddraw11-ticket-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Run simulation
        async function runSimulation() {
            const numDraws = parseInt(elements.simulationDraws.value);
            
            elements.runSimulationBtn.disabled = true;
            elements.simulationProgress.classList.remove('hidden');
            elements.simulationResults.classList.add('hidden');
            
            const simulationData = {
                draws: [],
                cardFrequency: {},
                rootDistribution: {},
                startTime: Date.now(),
                numDraws: numDraws
            };
            
            // Initialize card frequency and root distribution
            for (let suit of appState.suits) {
                for (let value = 1; value <= 10; value++) {
                    const cardKey = `${suit.name}-${value}`;
                    simulationData.cardFrequency[cardKey] = 0;
                }
            }
            
            for (let i = 1; i <= 9; i++) {
                simulationData.rootDistribution[i] = 0;
            }
            
            // Run simulation
            for (let i = 0; i < numDraws; i++) {
                // Generate a deck of 40 cards
                const deck = [];
                appState.suits.forEach(suit => {
                    for (let value = 1; value <= 10; value++) {
                        deck.push({
                            suit: suit,
                            value: value,
                            codex: (suit.position * 10) + value
                        });
                    }
                });
                
                // Draw 6 unique cards
                const drawnCards = [];
                const indices = new Uint16Array(6);
                crypto.getRandomValues(indices);
                
                for (let j = 0; j < 6; j++) {
                    const index = indices[j] % deck.length;
                    drawnCards.push(deck[index]);
                    deck.splice(index, 1);
                }
                
                // Calculate digital root
                const codexSum = drawnCards.reduce((sum, card) => sum + card.codex, 0);
                const root = calculateDigitalRootValue(codexSum);
                
                // Update statistics
                drawnCards.forEach(card => {
                    const cardKey = `${card.suit.name}-${card.value}`;
                    simulationData.cardFrequency[cardKey]++;
                });
                
                simulationData.rootDistribution[root]++;
                
                // Save draw data
                simulationData.draws.push({
                    cards: drawnCards,
                    codexSum: codexSum,
                    digitalRoot: root
                });
                
                // Update progress
                const progress = Math.round(((i + 1) / numDraws) * 100);
                elements.progressFill.style.width = `${progress}%`;
                elements.progressText.textContent = `${progress}%`;
                
                // Allow UI to update
                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 0));
                }
            }
            
            simulationData.endTime = Date.now();
            simulationData.duration = simulationData.endTime - simulationData.startTime;
            
            appState.simulationResults = simulationData;
            
            // Display results
            displaySimulationResults(simulationData);
            
            elements.runSimulationBtn.disabled = false;
        }

        // Display simulation results
        function displaySimulationResults(data) {
            elements.simulationResults.classList.remove('hidden');
            
            // Display card frequency chart
            displayCardFrequencyChart(data.cardFrequency);
            
            // Display root distribution chart
            displayRootDistributionChart(data.rootDistribution);
            
            // Display top cards with flip animation
            displayTopCardsWithFlip(data.cardFrequency);
            
            // Display sample draw
            displaySampleDraw(data.draws[data.draws.length - 1]); // Show last draw
            
            // Display summary
            displaySimulationSummary(data);
        }

        // Display top cards with flip animation
        function displayTopCardsWithFlip(cardFrequency) {
            elements.topCardsContainer.innerHTML = '';
            
            // Sort cards by frequency and get top 6
            const sortedCards = Object.entries(cardFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            // Create card objects for top cards
            const topCardObjects = sortedCards.map(([cardKey, frequency]) => {
                const [suitName, valueStr] = cardKey.split('-');
                const value = parseInt(valueStr);
                const suit = appState.suits.find(s => s.name === suitName);
                
                return {
                    suit: suit,
                    value: value,
                    codex: (suit.position * 10) + value,
                    frequency: frequency
                };
            });
            
            // Calculate lotto numbers and Powerball for the hypothetical draw of top 6 cards
            const codexSum = topCardObjects.reduce((sum, card) => sum + card.codex, 0);
            const powerballNumber = calculateDigitalRootValue(codexSum);
            
            // Update Powerball number display
            elements.topCardsPbNumber.textContent = powerballNumber;
            
            // Create card elements for top cards
            topCardObjects.forEach((card, index) => {
                const lottoNumber = ((card.codex - 1) % 40) + 1;
                
                const cardContainer = document.createElement('div');
                cardContainer.className = 'flex flex-col items-center';
                
                const cardElement = createSampleCardElement(card, lottoNumber, powerballNumber, true);
                
                // Add frequency label
                const frequencyLabel = document.createElement('div');
                frequencyLabel.className = 'text-xs mt-1 text-center';
                frequencyLabel.textContent = `${card.frequency} times`;
                
                cardContainer.appendChild(cardElement);
                cardContainer.appendChild(frequencyLabel);
                elements.topCardsContainer.appendChild(cardContainer);
                
                // Flip card with delay
                setTimeout(() => {
                    const cardDiv = cardElement.querySelector('.sample-card');
                    cardDiv.classList.add('flipped');
                }, index * (appState.settings.enableAnimations ? 200 : 0));
            });
        }

        // Display card frequency chart
        function displayCardFrequencyChart(cardFrequency) {
            elements.cardFrequencyChart.innerHTML = '';
            
            // Create a simple bar chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'h-full flex flex-col';
            
            // Create bars
            const barContainer = document.createElement('div');
            barContainer.className = 'flex-1 flex items-end justify-around';
            
            // Sort cards by frequency
            const sortedCards = Object.entries(cardFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Show top 10
            
            const maxFrequency = Math.max(...Object.values(cardFrequency));
            
            sortedCards.forEach(([card, frequency]) => {
                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex flex-col items-center w-8';
                
                const bar = document.createElement('div');
                const heightPercent = (frequency / maxFrequency) * 100;
                bar.className = 'w-6 bg-purple-600 rounded-t';
                bar.style.height = `${heightPercent}%`;
                
                const label = document.createElement('div');
                label.className = 'text-xs mt-1 text-center';
                label.textContent = card.replace('-', ' ');
                
                const value = document.createElement('div');
                value.className = 'text-xs font-bold';
                value.textContent = frequency;
                
                barWrapper.appendChild(bar);
                barWrapper.appendChild(label);
                barWrapper.appendChild(value);
                barContainer.appendChild(barWrapper);
            });
            
            chartContainer.appendChild(barContainer);
            elements.cardFrequencyChart.appendChild(chartContainer);
        }

        // Display root distribution chart
        function displayRootDistributionChart(rootDistribution) {
            elements.rootDistributionChart.innerHTML = '';
            
            // Create a simple bar chart
            const chartContainer = document.createElement('div');
            chartContainer.className = 'h-full flex flex-col';
            
            // Create bars
            const barContainer = document.createElement('div');
            barContainer.className = 'flex-1 flex items-end justify-around';
            
            const maxFrequency = Math.max(...Object.values(rootDistribution));
            
            for (let i = 1; i <= 9; i++) {
                const frequency = rootDistribution[i];
                
                const barWrapper = document.createElement('div');
                barWrapper.className = 'flex flex-col items-center w-8';
                
                const bar = document.createElement('div');
                const heightPercent = (frequency / maxFrequency) * 100;
                bar.className = 'w-6 bg-pink-600 rounded-t';
                bar.style.height = `${heightPercent}%`;
                
                const label = document.createElement('div');
                label.className = 'text-xs mt-1';
                label.textContent = i;
                
                const value = document.createElement('div');
                value.className = 'text-xs font-bold';
                value.textContent = frequency;
                
                barWrapper.appendChild(bar);
                barWrapper.appendChild(label);
                barWrapper.appendChild(value);
                barContainer.appendChild(barWrapper);
            }
            
            chartContainer.appendChild(barContainer);
            elements.rootDistributionChart.appendChild(chartContainer);
        }

        // Display sample draw from simulation
        function displaySampleDraw(draw) {
            elements.sampleCardsContainer.innerHTML = '';
            elements.samplePowerballNumbers.innerHTML = '';
            
            // Render cards
            draw.cards.forEach(card => {
                const cardElement = createSampleCardElement(card);
                elements.sampleCardsContainer.appendChild(cardElement);
                
                // Flip card immediately for sample draw
                setTimeout(() => {
                    const cardDiv = cardElement.querySelector('.sample-card');
                    cardDiv.classList.add('flipped');
                }, 100);
            });
            
            // Set digital root
            elements.sampleOrb.textContent = draw.digitalRoot;
            
            // Generate Powerball numbers
            const numbers = draw.cards.map(card => {
                return ((card.codex - 1) % 40) + 1;
            });
            
            numbers.sort((a, b) => a - b);
            
            // Display numbers
            numbers.forEach(num => {
                const numberElement = document.createElement('div');
                numberElement.className = 'bg-white text-gray-900 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm';
                numberElement.textContent = num;
                elements.samplePowerballNumbers.appendChild(numberElement);
            });
            
            // Set Powerball number
            elements.samplePowerballNumber.textContent = `PB: ${draw.digitalRoot}`;
        }

        // Display simulation summary
        function displaySimulationSummary(data) {
            elements.simulationSummary.innerHTML = '';
            
            // Calculate statistics
            const totalDraws = data.draws.length;
            const avgCodexSum = data.draws.reduce((sum, draw) => sum + draw.codexSum, 0) / totalDraws;
            
            // Find most frequent cards
            const sortedCards = Object.entries(data.cardFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            // Find most frequent root
            const sortedRoots = Object.entries(data.rootDistribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            const summaryHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h4 class="font-medium mb-2">Simulation Stats</h4>
                        <p>Total draws: ${totalDraws}</p>
                        <p>Duration: ${(data.duration / 1000).toFixed(2)} seconds</p>
                        <p>Avg codex sum: ${avgCodexSum.toFixed(2)}</p>
                    </div>
                    <div>
                        <h4 class="font-medium mb-2">Most Frequent Cards</h4>
                        ${sortedCards.map(([card, freq]) => 
                            `<p>${card.replace('-', ' ')}: ${freq} times (${(freq/totalDraws*100).toFixed(1)}%)</p>`
                        ).join('')}
                    </div>
                    <div>
                        <h4 class="font-medium mb-2">Most Frequent Roots</h4>
                        ${sortedRoots.map(([root, freq]) => 
                            `<p>Root ${root}: ${freq} times (${(freq/totalDraws*100).toFixed(1)}%)</p>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            elements.simulationSummary.innerHTML = summaryHTML;
        }

        // Export simulation results
        function exportSimulation() {
            if (!appState.simulationResults) return;
            
            const dataStr = JSON.stringify(appState.simulationResults, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `carddraw11-simulation-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // History management
        function saveToHistory(cards) {
            const codexSum = cards.reduce((sum, card) => sum + card.codex, 0);
            const root = calculateDigitalRootValue(codexSum);
            
            const historyEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                cards: cards.map(card => ({
                    suit: card.suit.name,
                    value: card.value,
                    codex: card.codex
                })),
                codexSum: codexSum,
                digitalRoot: root,
                type: 'manual'
            };
            
            appState.history.unshift(historyEntry);
            
            // Keep only the last 100 entries
            if (appState.history.length > 100) {
                appState.history = appState.history.slice(0, 100);
            }
            
            saveHistory();
            renderHistory();
            
            // Create summary every 10 draws
            if (appState.history.length % 10 === 0) {
                createHistorySummary();
            }
        }

        function renderHistory() {
            if (appState.history.length === 0) {
                elements.historyContainer.classList.add('hidden');
                elements.emptyHistory.classList.remove('hidden');
                return;
            }
            
            elements.historyContainer.classList.remove('hidden');
            elements.emptyHistory.classList.add('hidden');
            
            elements.historyContainer.innerHTML = '';
            
            appState.history.forEach(entry => {
                const historyItem = document.createElement('div');
                historyItem.className = 'bg-gray-700 rounded-lg p-4';
                
                const date = new Date(entry.timestamp);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium">${formattedDate}</div>
                            <div class="text-sm text-gray-400">Type: ${entry.type}</div>
                            <div class="mt-2 flex flex-wrap gap-2">
                                ${entry.cards ? entry.cards.map(card => 
                                    `<div class="bg-gray-600 px-2 py-1 rounded text-sm">
                                        ${card.suit.charAt(0).toUpperCase() + card.suit.slice(1)} ${card.value}
                                    </div>`
                                ).join('') : '<div class="text-sm">Summary of last 10 draws</div>'}
                            </div>
                            ${entry.cards ? `
                                <div class="mt-2 text-sm">
                                    Codex Sum: ${entry.codexSum} | Digital Root: ${entry.digitalRoot}
                                </div>
                            ` : ''}
                        </div>
                        ${entry.cards ? `
                            <div>
                                <button class="text-sm bg-gray-600 px-2 py-1 rounded hover:bg-gray-500" data-id="${entry.id}">
                                    Recreate
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Add recreate button event listener if it exists
                const recreateBtn = historyItem.querySelector('button');
                if (recreateBtn) {
                    recreateBtn.addEventListener('click', () => recreateDraw(entry.id));
                }
                
                elements.historyContainer.appendChild(historyItem);
            });
        }

        function recreateDraw(id) {
            const entry = appState.history.find(item => item.id === id);
            if (!entry || !entry.cards) return;
            
            // Switch to draw tab
            switchTab('draw');
            
            // Recreate cards from history
            const recreatedCards = entry.cards.map(cardData => {
                const suit = appState.suits.find(s => s.name === cardData.suit);
                return {
                    suit: suit,
                    value: cardData.value,
                    codex: cardData.codex
                };
            });
            
            appState.currentCards = recreatedCards;
            
            // Render cards
            renderCards(recreatedCards);
            
            // Calculate digital root
            setTimeout(() => {
                calculateDigitalRoot(recreatedCards);
            }, appState.settings.enableAnimations ? 2000 : 0);
        }

        function createHistorySummary() {
            const last10Draws = appState.history.filter(entry => entry.type === 'manual').slice(0, 10);
            
            if (last10Draws.length < 10) return;
            
            const summary = {
                timestamp: new Date().toISOString(),
                drawCount: last10Draws.length,
                avgCodexSum: last10Draws.reduce((sum, entry) => sum + entry.codexSum, 0) / last10Draws.length,
                rootDistribution: {},
                mostFrequentCards: {}
            };
            
            // Calculate root distribution
            for (let i = 1; i <= 9; i++) {
                summary.rootDistribution[i] = 0;
            }
            
            last10Draws.forEach(entry => {
                summary.rootDistribution[entry.digitalRoot]++;
                
                entry.cards.forEach(card => {
                    const cardKey = `${card.suit}-${card.value}`;
                    summary.mostFrequentCards[cardKey] = (summary.mostFrequentCards[cardKey] || 0) + 1;
                });
            });
            
            // Save summary to history
            appState.history.unshift({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: 'summary',
                summary: summary
            });
            
            saveHistory();
            renderHistory();
        }

        function exportHistory(format) {
            if (appState.history.length === 0) return;
            
            let dataStr, exportFileDefaultName, mimeType;
            
            if (format === 'json') {
                dataStr = JSON.stringify(appState.history, null, 2);
                exportFileDefaultName = `carddraw11-history-${Date.now()}.json`;
                mimeType = 'application/json';
            } else if (format === 'csv') {
                // Create CSV header
                let csv = 'ID,Timestamp,Type,Cards,Codex Sum,Digital Root\n';
                
                // Add history entries
                appState.history.forEach(entry => {
                    const cards = entry.cards ? 
                        entry.cards.map(card => `${card.suit} ${card.value}`).join(';') : 
                        'Summary';
                    
                    const row = [
                        entry.id,
                        entry.timestamp,
                        entry.type,
                        `"${cards}"`,
                        entry.codexSum || '',
                        entry.digitalRoot || ''
                    ].join(',');
                    
                    csv += row + '\n';
                });
                
                dataStr = csv;
                exportFileDefaultName = `carddraw11-history-${Date.now()}.csv`;
                mimeType = 'text/csv';
            }
            
            const dataUri = `data:${mimeType};charset=utf-8,${encodeURIComponent(dataStr)}`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                appState.history = [];
                saveHistory();
                renderHistory();
                updateFrequentNumbers();
            }
        }

        // Settings management
        function loadSettings() {
            const savedSettings = localStorage.getItem('cardDraw11_settings');
            if (savedSettings) {
                appState.settings = { ...appState.settings, ...JSON.parse(savedSettings) };
            }
            
            const savedSuitOrder = localStorage.getItem('cardDraw11_suitOrder');
            if (savedSuitOrder) {
                appState.suits = JSON.parse(savedSuitOrder);
            }
            
            // Update UI
            elements.saveHistoryCheckbox.checked = appState.settings.saveHistory;
            elements.enableAnimationsCheckbox.checked = appState.settings.enableAnimations;
            elements.showTarotMeaningsCheckbox.checked = appState.settings.showTarotMeanings;
        }

        function saveSettings() {
            localStorage.setItem('cardDraw11_settings', JSON.stringify(appState.settings));
            localStorage.setItem('cardDraw11_suitOrder', JSON.stringify(appState.suits));
        }

        function updateSetting(e) {
            const setting = e.target.id.replace('-checkbox', '');
            const value = e.target.checked;
            
            appState.settings[setting] = value;
            saveSettings();
        }

        // History management
        function loadHistory() {
            const savedHistory = localStorage.getItem('cardDraw11_history');
            if (savedHistory) {
                appState.history = JSON.parse(savedHistory);
            }
        }

        function saveHistory() {
            if (appState.settings.saveHistory) {
                localStorage.setItem('cardDraw11_history', JSON.stringify(appState.history));
            }
        }

        // Import data
        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (data.settings) {
                        appState.settings = { ...appState.settings, ...data.settings };
                        elements.saveHistoryCheckbox.checked = appState.settings.saveHistory;
                        elements.enableAnimationsCheckbox.checked = appState.settings.enableAnimations;
                        elements.showTarotMeaningsCheckbox.checked = appState.settings.showTarotMeanings;
                    }
                    
                    if (data.suits) {
                        appState.suits = data.suits;
                        renderSuitOrder();
                    }
                    
                    if (data.history) {
                        appState.history = data.history;
                        renderHistory();
                        updateFrequentNumbers();
                    }
                    
                    if (data.powerballResults) {
                        appState.powerballResults = data.powerballResults;
                    }
                    
                    saveSettings();
                    saveHistory();
                    
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        }

        // PWA setup
        function setupPWA() {
            if ('serviceWorker' in navigator) {
                // Try to register the external service worker first
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service worker registered successfully:', registration);
                    })
                    .catch(error => {
                        console.log('External service worker registration failed, trying inline fallback:', error);
                        
                        // Fallback: create a simple service worker blob
                        try {
                            const swCode = `
                                self.addEventListener('install', event => {
                                    console.log('Service worker installing...');
                                    self.skipWaiting();
                                });
                                
                                self.addEventListener('activate', event => {
                                    console.log('Service worker activating...');
                                    event.waitUntil(self.clients.claim());
                                });
                                
                                self.addEventListener('fetch', event => {
                                    // For now, just fetch normally
                                    event.respondWith(fetch(event.request));
                                });
                            `;
                            
                            const blob = new Blob([swCode], { type: 'application/javascript' });
                            const swUrl = URL.createObjectURL(blob);
                            
                            return navigator.serviceWorker.register(swUrl);
                        } catch (blobError) {
                            console.log('Blob service worker registration also failed:', blobError);
                            // If all else fails, just continue without service worker
                        }
                    });
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
